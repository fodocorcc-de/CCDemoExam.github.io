<!DOCTYPE html>
<html>
<head>
<title>Exam System</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
body {
  font-family: 'Orbitron', 'Rajdhani', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace;
  background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #0f1419 100%);
  color: #00f3ff;
  line-height: 1.6;
  margin: 0;
  padding: 10px;
  position: relative;
  overflow-x: hidden;
}

body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background:
    repeating-linear-gradient(
      0deg,
      rgba(0, 243, 255, 0.03) 0px,
      transparent 1px,
      transparent 2px,
      rgba(0, 243, 255, 0.03) 3px
    );
  pointer-events: none;
  z-index: 1;
  animation: scanlines 8s linear infinite;
}

@keyframes scanlines {
  0% { transform: translateY(0); }
  100% { transform: translateY(10px); }
}

#exam-container {
  max-width: 800px;
  width: 95%;
  margin: 20px auto;
  padding: 20px;
  border: 2px solid #00f3ff;
  border-radius: 12px;
  background: rgba(10, 14, 39, 0.95);
  box-shadow:
    0 0 30px rgba(0, 243, 255, 0.4),
    inset 0 0 60px rgba(0, 243, 255, 0.05),
    0 8px 32px rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(10px);
  position: relative;
  z-index: 2;
  animation: containerGlow 3s ease-in-out infinite alternate;
}

@keyframes containerGlow {
  0% { box-shadow: 0 0 20px rgba(0, 243, 255, 0.3), inset 0 0 60px rgba(0, 243, 255, 0.05), 0 8px 32px rgba(0, 0, 0, 0.6); }
  100% { box-shadow: 0 0 40px rgba(0, 243, 255, 0.6), inset 0 0 60px rgba(0, 243, 255, 0.1), 0 8px 32px rgba(0, 0, 0, 0.6); }
}

h1, h2, h3, h4 {
  color: #00f3ff;
  margin-top: 0;
  text-shadow: 0 0 10px rgba(0, 243, 255, 0.8), 0 0 20px rgba(0, 243, 255, 0.4);
  font-weight: 700;
  letter-spacing: 2px;
}

h1#exam-title {
  font-size: 1.8em;
  margin-bottom: 25px;
  text-align: center;
  color: #00f3ff;
  text-transform: uppercase;
  background: linear-gradient(90deg, #00f3ff, #a855f7, #00f3ff);
  background-size: 200% auto;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  animation: textShine 4s linear infinite;
}

@keyframes textShine {
  0% { background-position: 0% center; }
  100% { background-position: 200% center; }
}

#welcome-message {
    text-align: center;
    font-size: 1.1em;
    color: #9de2ff;
    margin-bottom: 20px;
    text-shadow: 0 0 8px rgba(157, 226, 255, 0.6);
}

#initial-load-instructions {
    padding: 15px;
    background: rgba(0, 243, 255, 0.05);
    border: 1px solid rgba(0, 243, 255, 0.3);
    border-radius: 8px;
    margin-bottom: 25px;
    box-shadow: 0 0 15px rgba(0, 243, 255, 0.1);
}

#initial-load-instructions p, #initial-load-instructions ul {
    color: #9de2ff;
}
#initial-load-instructions ul {
    padding-left: 20px;
}
#initial-load-instructions li {
    margin-bottom: 8px;
}

label {
    display: block;
    margin-bottom: 6px;
    font-weight: 500;
    color: #00f3ff;
    text-shadow: 0 0 5px rgba(0, 243, 255, 0.3);
}
label.inline-label {
    display: inline-block;
    margin-bottom: 0;
    margin-left: 5px;
    font-weight: normal;
}
label.disabled-label {
    color: #4a5568 !important;
    cursor: not-allowed;
    text-shadow: none;
}


input[type="text"],
input[type="number"],
select {
    width: 100%;
    max-width: 400px;
    padding: 10px 12px;
    margin-bottom: 15px;
    border: 1px solid rgba(0, 243, 255, 0.4);
    border-radius: 6px;
    box-sizing: border-box;
    font-size: 1em;
    background: rgba(10, 14, 39, 0.8);
    color: #00f3ff;
    transition: all 0.3s ease;
}
input[type="text"]:focus,
input[type="number"]:focus,
select:focus {
    border-color: #00f3ff;
    box-shadow: 0 0 15px rgba(0, 243, 255, 0.5), inset 0 0 10px rgba(0, 243, 255, 0.1);
    outline: none;
    background: rgba(10, 14, 39, 0.95);
}
select {
    width: auto;
    min-width: 150px;
    margin-bottom: 5px;
}
input[type="number"].short-input {
    width: 80px !important;
    max-width: none;
    margin-left: 10px;
    margin-bottom: 5px;
    display: inline-block;
}
#exam-duration-setup-input {
    width: 100px;
    margin-bottom: 10px;
}


#question-container {
  margin-bottom: 20px;
  padding: 20px;
  background: linear-gradient(135deg, rgba(0, 243, 255, 0.05) 0%, rgba(168, 85, 247, 0.05) 100%);
  border-radius: 8px;
  border: 1px solid rgba(0, 243, 255, 0.3);
  box-shadow: 0 0 20px rgba(0, 243, 255, 0.2), inset 0 0 20px rgba(0, 243, 255, 0.05);
}

#question {
  margin-bottom: 20px;
  font-size: 1.25em;
  font-weight: 500;
  color: #00f3ff;
  text-shadow: 0 0 8px rgba(0, 243, 255, 0.5);
}

#timer {
  margin-bottom: 20px;
  font-size: 1.1em;
  font-weight: 600;
  color: #ff2d95;
  background: rgba(255, 45, 149, 0.1);
  padding: 10px 15px;
  border-radius: 6px;
  text-align: center;
  border: 1px solid rgba(255, 45, 149, 0.4);
  box-shadow: 0 0 15px rgba(255, 45, 149, 0.3);
  transition: all 0.3s ease;
  text-shadow: 0 0 10px rgba(255, 45, 149, 0.8);
}

@keyframes breathe {
  0% {
    background: rgba(255, 45, 149, 0.1);
    box-shadow: 0 0 15px rgba(255, 45, 149, 0.3);
  }
  50% {
    background: rgba(255, 45, 149, 0.25);
    box-shadow: 0 0 30px rgba(255, 45, 149, 0.6);
  }
  100% {
    background: rgba(255, 45, 149, 0.1);
    box-shadow: 0 0 15px rgba(255, 45, 149, 0.3);
  }
}

.timer-warning {
    animation: breathe 1.5s infinite;
}

.time-flag {
    color: #e74c3c;
    margin-left: 10px;
    display: inline-flex;
    align-items: center;
}

.time-flag svg {
    width: 1em;
    height: 1em;
}

.choice {
  margin-bottom: 12px;
  background: rgba(0, 243, 255, 0.05);
  border: 1px solid rgba(0, 243, 255, 0.3);
  padding: 12px 15px;
  border-radius: 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}
.choice::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  width: 0;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(0, 243, 255, 0.2), transparent);
  transition: width 0.3s ease;
}
.choice:hover {
  background: rgba(0, 243, 255, 0.15);
  border-color: #00f3ff;
  box-shadow: 0 0 20px rgba(0, 243, 255, 0.3);
  transform: translateX(5px);
}
.choice:hover::before {
  width: 100%;
}
.choice input[type="radio"] {
  margin-right: 12px;
  transform: scale(1.2);
  accent-color: #00f3ff;
  filter: drop-shadow(0 0 5px rgba(0, 243, 255, 0.6));
}
.choice label {
  margin-bottom: 0;
  font-weight: normal;
  color: #9de2ff;
  flex-grow: 1;
  text-shadow: none;
}


.explanation {
  margin-top: 15px;
  padding: 12px;
  font-style: normal;
  background: rgba(168, 85, 247, 0.1);
  border-left: 4px solid #a855f7;
  border-radius: 0 6px 6px 0;
  color: #d8b4fe;
  font-size: 0.95em;
  box-shadow: 0 0 15px rgba(168, 85, 247, 0.2);
  text-shadow: 0 0 5px rgba(168, 85, 247, 0.3);
}

#results-container {
  margin-top: 30px;
  border: 2px solid rgba(0, 243, 255, 0.5);
  padding: 25px;
  border-radius: 10px;
  background: linear-gradient(135deg, rgba(0, 243, 255, 0.1) 0%, rgba(168, 85, 247, 0.1) 100%);
  box-shadow: 0 0 30px rgba(0, 243, 255, 0.3), inset 0 0 30px rgba(0, 243, 255, 0.05);
}
#results-container h2 {
    text-align: center;
    font-size: 1.8em;
    margin-bottom: 20px;
    background: linear-gradient(90deg, #00f3ff, #a855f7);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}
#results-container p {
    font-size: 1.05em;
    margin-bottom: 10px;
    color: #9de2ff;
}
#results-container p span {
    font-weight: 600;
    color: #00f3ff;
    text-shadow: 0 0 8px rgba(0, 243, 255, 0.6);
}

.review-link {
  cursor: pointer;
  color: #00f3ff;
  text-decoration: none;
  font-weight: 500;
  transition: all 0.3s ease;
  text-shadow: 0 0 5px rgba(0, 243, 255, 0.5);
}
.review-link:hover {
  color: #a855f7;
  text-decoration: none;
  text-shadow: 0 0 10px rgba(168, 85, 247, 0.8);
}

.review-list-item {
  background: rgba(0, 243, 255, 0.05);
  border: 1px solid rgba(0, 243, 255, 0.3);
  padding: 15px;
  margin-bottom: 10px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 0 10px rgba(0, 243, 255, 0.1);
  position: relative;
}

.review-list-item:hover {
  background: rgba(0, 243, 255, 0.15);
  border-color: #00f3ff;
  box-shadow: 0 0 20px rgba(0, 243, 255, 0.3);
  transform: translateX(5px);
}

.review-arrow {
    float: right;
    color: #3498db;
    transition: transform 0.2s ease-in-out;
    padding-left: 10px;
}

.review-arrow svg {
    width: 1.2em;
    height: 1.2em;
}

.review-details {
    display: none;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px dashed #d1d8e0;
}
.review-details p {
    margin-bottom: 8px;
    font-size: 0.95em;
}


.domain-result {
    margin-bottom: 8px;
    padding: 10px 12px;
    background: rgba(0, 243, 255, 0.1);
    border-left: 4px solid #00f3ff;
    border-radius: 6px;
    color: #9de2ff;
    box-shadow: 0 0 10px rgba(0, 243, 255, 0.15);
}

/* --- BUTTONS --- */
.button-base {
    padding: 10px 18px;
    font-size: 1em;
    border: 1px solid rgba(0, 243, 255, 0.5);
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.3s ease;
    font-weight: 600;
    text-align: center;
    color: #0a0e27;
    display: inline-block;
    background: linear-gradient(135deg, #00f3ff 0%, #00d4ff 100%);
    box-shadow: 0 0 15px rgba(0, 243, 255, 0.4);
    text-transform: uppercase;
    letter-spacing: 1px;
    position: relative;
    overflow: hidden;
}
.button-base::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: left 0.5s ease;
}
.button-base:hover::before {
    left: 100%;
}
.button-base:hover {
    box-shadow: 0 0 30px rgba(0, 243, 255, 0.8), 0 0 50px rgba(0, 243, 255, 0.4);
    transform: translateY(-2px);
    border-color: #00f3ff;
}
.button-base:active {
    transform: translateY(0px);
    box-shadow: 0 0 15px rgba(0, 243, 255, 0.6);
}
.button-base:disabled {
    background: rgba(100, 100, 100, 0.3) !important;
    color: #4a5568 !important;
    cursor: not-allowed;
    box-shadow: none;
    transform: none;
    border-color: rgba(100, 100, 100, 0.3);
}

#start-button {
  margin: 20px auto 0;
  padding: 12px 25px;
  font-size: 1.2em;
  background: linear-gradient(135deg, #00f3ff 0%, #a855f7 100%);
  display: block;
  width: fit-content;
  animation: pulse 2s ease-in-out infinite;
}
#start-button:hover{
    background: linear-gradient(135deg, #a855f7 0%, #00f3ff 100%);
    animation: none;
}

@keyframes pulse {
  0%, 100% { box-shadow: 0 0 20px rgba(0, 243, 255, 0.4); }
  50% { box-shadow: 0 0 40px rgba(0, 243, 255, 0.8), 0 0 60px rgba(168, 85, 247, 0.6); }
}

.nav-button {
    background: linear-gradient(135deg, #00f3ff 0%, #00a8cc 100%);
    margin: 5px 3px;
}
.nav-button:hover {
    background: linear-gradient(135deg, #00a8cc 0%, #00f3ff 100%);
}

#submit-button {
    background: linear-gradient(135deg, #a855f7 0%, #d946ef 100%);
}
#submit-button:hover{
    background: linear-gradient(135deg, #d946ef 0%, #a855f7 100%);
}

#load-url-button, #browse-file-button {
    background: linear-gradient(135deg, #00f3ff 0%, #00d4ff 100%);
    margin-bottom: 5px;
}
#load-url-button:hover, #browse-file-button:hover {
    background: linear-gradient(135deg, #00d4ff 0%, #00f3ff 100%);
}
#run-demo-button {
    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    margin-top: 15px;
    color: #0a0e27;
}
#run-demo-button:hover {
    background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
}

#file-input-container {
    margin-bottom: 15px;
}
#selected-file-name {
    margin-left: 10px;
    font-style: italic;
    color: #555;
    font-size: 0.9em;
}


/* Progress Bar Styles */
#progress-bar-container {
    width: 100%;
    background: rgba(0, 243, 255, 0.1);
    margin-bottom: 8px;
    border-radius: 8px;
    overflow: hidden;
    height: 12px;
    border: 1px solid rgba(0, 243, 255, 0.3);
    box-shadow: inset 0 0 10px rgba(0, 243, 255, 0.1);
}

#progress-bar {
    width: 0%;
    height: 100%;
    background: linear-gradient(90deg, #00f3ff, #a855f7, #00f3ff);
    background-size: 200% auto;
    text-align: center;
    color: white;
    transition: width 0.4s ease-in-out;
    border-radius: 8px;
    box-shadow: 0 0 15px rgba(0, 243, 255, 0.6);
    animation: progressShine 2s linear infinite;
}

@keyframes progressShine {
    0% { background-position: 0% center; }
    100% { background-position: 200% center; }
}

#progress-text {
    text-align: center;
    margin-bottom: 15px;
    font-size: 0.9em;
    color: #9de2ff;
}

/* Exam Setup Options Specific Styles */
#exam-setup-options {
    margin-top: 20px;
    padding: 20px;
    border: 1px solid rgba(0, 243, 255, 0.3);
    border-radius: 8px;
    background: rgba(0, 243, 255, 0.05);
    box-shadow: 0 0 15px rgba(0, 243, 255, 0.1);
}
#exam-setup-options h4 {
    margin-bottom: 15px;
    color: #00f3ff;
    border-bottom: 1px solid rgba(0, 243, 255, 0.3);
    padding-bottom: 10px;
}
#exam-setup-options > div {
    margin-bottom: 15px;
}
.setup-option-group {
    margin-bottom: 15px;
}
.setup-details {
    margin-left: 25px;
    font-size: 0.9em;
    color: #555;
    margin-top: 5px;
}
#custom-domain-selection {
    max-height: 150px;
    overflow-y: auto;
    border: 1px solid rgba(0, 243, 255, 0.3);
    padding: 10px;
    border-radius: 6px;
    background: rgba(10, 14, 39, 0.5);
}

#custom-domain-selection::-webkit-scrollbar {
    width: 8px;
}

#custom-domain-selection::-webkit-scrollbar-track {
    background: rgba(0, 243, 255, 0.1);
    border-radius: 4px;
}

#custom-domain-selection::-webkit-scrollbar-thumb {
    background: rgba(0, 243, 255, 0.5);
    border-radius: 4px;
}

#custom-domain-selection::-webkit-scrollbar-thumb:hover {
    background: #00f3ff;
}
.domain-checkbox-item {
    display: block;
    margin-bottom: 5px;
}

#custom-setup-warning {
    color: #ff2d95;
    font-weight: bold;
    text-shadow: 0 0 8px rgba(255, 45, 149, 0.6);
}
#effective-settings-summary {
    margin-top: 15px;
    padding: 10px;
    background: rgba(0, 243, 255, 0.1);
    border: 1px solid rgba(0, 243, 255, 0.3);
    border-radius: 6px;
    font-weight: 500;
    color: #9de2ff;
    box-shadow: 0 0 10px rgba(0, 243, 255, 0.15);
}
select option:disabled {
    color: #ccc;
    background-color: #f9f9f9;
}
#version-info {
  text-align: center;
  margin-top: 30px;
  padding-bottom: 20px;
  font-size: 0.85em;
  color: #777;
}

/* Dark Mode Styles - Ultra Cyber Mode */
body.dark-mode {
    background: linear-gradient(135deg, #000000 0%, #0a0e27 50%, #000509 100%);
    color: #ff2d95;
}
body.dark-mode #exam-container {
    background: rgba(0, 0, 0, 0.98);
    border-color: #ff2d95;
    box-shadow:
        0 0 40px rgba(255, 45, 149, 0.6),
        inset 0 0 80px rgba(255, 45, 149, 0.08),
        0 8px 32px rgba(0, 0, 0, 0.9);
}
body.dark-mode h1, body.dark-mode h2, body.dark-mode h3, body.dark-mode h4,
body.dark-mode h1#exam-title, body.dark-mode #welcome-message {
    color: #ff2d95;
    text-shadow: 0 0 15px rgba(255, 45, 149, 1), 0 0 30px rgba(255, 45, 149, 0.6);
}
body.dark-mode h1#exam-title {
    background: linear-gradient(90deg, #ff2d95, #a855f7, #ff2d95);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}
body.dark-mode #question-container,
body.dark-mode #results-container,
body.dark-mode #initial-load-instructions,
body.dark-mode #exam-setup-options {
    background: linear-gradient(135deg, rgba(255, 45, 149, 0.08) 0%, rgba(168, 85, 247, 0.08) 100%);
    border-color: rgba(255, 45, 149, 0.5);
    box-shadow: 0 0 25px rgba(255, 45, 149, 0.3), inset 0 0 25px rgba(255, 45, 149, 0.08);
}
body.dark-mode .choice {
    background: rgba(255, 45, 149, 0.08);
    border-color: rgba(255, 45, 149, 0.4);
}
body.dark-mode .choice:hover {
    background: rgba(255, 45, 149, 0.2);
    border-color: #ff2d95;
    box-shadow: 0 0 25px rgba(255, 45, 149, 0.5);
}
body.dark-mode label, body.dark-mode p, body.dark-mode li {
    color: #ffb3d9;
}
body.dark-mode .choice label {
    color: #ffcce6;
}
body.dark-mode input[type="text"],
body.dark-mode input[type="number"],
body.dark-mode select {
    background: rgba(0, 0, 0, 0.9);
    color: #ff2d95;
    border-color: rgba(255, 45, 149, 0.5);
}
body.dark-mode input[type="text"]:focus,
body.dark-mode input[type="number"]:focus,
body.dark-mode select:focus {
    border-color: #ff2d95;
    box-shadow: 0 0 20px rgba(255, 45, 149, 0.6), inset 0 0 15px rgba(255, 45, 149, 0.15);
}
body.dark-mode .review-list-item {
    background: rgba(255, 45, 149, 0.08);
    border-color: rgba(255, 45, 149, 0.4);
}
body.dark-mode .review-list-item:hover {
    background: rgba(255, 45, 149, 0.18);
    border-color: #ff2d95;
    box-shadow: 0 0 25px rgba(255, 45, 149, 0.4);
}
body.dark-mode .explanation {
    background: rgba(168, 85, 247, 0.15);
    border-left-color: #a855f7;
    color: #e9d5ff;
    box-shadow: 0 0 20px rgba(168, 85, 247, 0.3);
}
body.dark-mode .domain-result {
    background: rgba(255, 45, 149, 0.15);
    border-left-color: #ff2d95;
    color: #ffcce6;
    box-shadow: 0 0 15px rgba(255, 45, 149, 0.25);
}

/* Dark Mode Toggle */
#dark-mode-toggle {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    background: linear-gradient(135deg, #00f3ff 0%, #00d4ff 100%);
    border: 1px solid rgba(0, 243, 255, 0.5);
    color: #0a0e27;
    width: 45px;
    height: 45px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1.3em;
    transition: all 0.3s ease;
    box-shadow: 0 0 20px rgba(0, 243, 255, 0.5);
    font-weight: bold;
}
#dark-mode-toggle:hover {
    background: linear-gradient(135deg, #00d4ff 0%, #00f3ff 100%);
    transform: scale(1.15);
    box-shadow: 0 0 30px rgba(0, 243, 255, 0.8);
}
body.dark-mode #dark-mode-toggle {
    background: linear-gradient(135deg, #ff2d95 0%, #d946ef 100%);
    border-color: rgba(255, 45, 149, 0.5);
    color: #fff;
    box-shadow: 0 0 20px rgba(255, 45, 149, 0.6);
}
body.dark-mode #dark-mode-toggle:hover {
    background: linear-gradient(135deg, #d946ef 0%, #ff2d95 100%);
    box-shadow: 0 0 35px rgba(255, 45, 149, 0.9);
}

/* Dashboard Button */
#dashboard-button:hover {
    background-color: #7c3aed !important;
    transform: scale(1.1);
}

/* Question Navigator */
#question-navigator {
    position: fixed;
    right: 20px;
    top: 80px;
    width: 200px;
    background: rgba(10, 14, 39, 0.95);
    border: 1px solid rgba(0, 243, 255, 0.4);
    border-radius: 10px;
    padding: 15px;
    box-shadow: 0 0 25px rgba(0, 243, 255, 0.3), inset 0 0 20px rgba(0, 243, 255, 0.05);
    max-height: 70vh;
    overflow-y: auto;
    display: none;
    z-index: 999;
    backdrop-filter: blur(10px);
}
body.dark-mode #question-navigator {
    background: rgba(0, 0, 0, 0.98);
    border-color: rgba(255, 45, 149, 0.5);
    box-shadow: 0 0 30px rgba(255, 45, 149, 0.4), inset 0 0 25px rgba(255, 45, 149, 0.08);
}
#question-navigator h4 {
    margin-top: 0;
    margin-bottom: 10px;
    font-size: 0.9em;
    color: #00f3ff;
    text-shadow: 0 0 8px rgba(0, 243, 255, 0.6);
}
body.dark-mode #question-navigator h4 {
    color: #ff2d95;
    text-shadow: 0 0 10px rgba(255, 45, 149, 0.8);
}
.nav-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 5px;
}
.nav-question-btn {
    padding: 8px;
    border: 1px solid rgba(0, 243, 255, 0.3);
    background: rgba(0, 243, 255, 0.1);
    cursor: pointer;
    border-radius: 6px;
    font-size: 0.8em;
    text-align: center;
    transition: all 0.3s ease;
    color: #9de2ff;
    font-weight: 600;
}
.nav-question-btn:hover {
    background: rgba(0, 243, 255, 0.25);
    transform: scale(1.08);
    box-shadow: 0 0 15px rgba(0, 243, 255, 0.4);
}
.nav-question-btn.answered {
    background: rgba(168, 85, 247, 0.3);
    border-color: #a855f7;
    box-shadow: 0 0 10px rgba(168, 85, 247, 0.4);
}
.nav-question-btn.current {
    background: linear-gradient(135deg, #00f3ff, #a855f7);
    color: #0a0e27;
    border-color: #00f3ff;
    box-shadow: 0 0 15px rgba(0, 243, 255, 0.6);
}
.nav-question-btn.bookmarked::after {
    content: '★';
    color: #fbbf24;
    font-size: 1.1em;
    filter: drop-shadow(0 0 5px rgba(251, 191, 36, 0.8));
}
body.dark-mode .nav-question-btn {
    background: rgba(255, 45, 149, 0.1);
    border-color: rgba(255, 45, 149, 0.3);
    color: #ffcce6;
}
body.dark-mode .nav-question-btn:hover {
    background: rgba(255, 45, 149, 0.25);
    box-shadow: 0 0 18px rgba(255, 45, 149, 0.5);
}
body.dark-mode .nav-question-btn.answered {
    background: rgba(168, 85, 247, 0.3);
    border-color: #a855f7;
}
body.dark-mode .nav-question-btn.current {
    background: linear-gradient(135deg, #ff2d95, #a855f7);
    color: #fff;
    border-color: #ff2d95;
    box-shadow: 0 0 20px rgba(255, 45, 149, 0.7);
}

#question-navigator::-webkit-scrollbar {
    width: 8px;
}

#question-navigator::-webkit-scrollbar-track {
    background: rgba(0, 243, 255, 0.1);
    border-radius: 4px;
}

#question-navigator::-webkit-scrollbar-thumb {
    background: rgba(0, 243, 255, 0.5);
    border-radius: 4px;
}

#question-navigator::-webkit-scrollbar-thumb:hover {
    background: #00f3ff;
}

body.dark-mode #question-navigator::-webkit-scrollbar-thumb {
    background: rgba(255, 45, 149, 0.5);
}

body.dark-mode #question-navigator::-webkit-scrollbar-thumb:hover {
    background: #ff2d95;
}

/* Pause/Resume Button */
#pause-resume-button {
    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    margin: 5px 3px;
    color: #0a0e27;
}
#pause-resume-button:hover {
    background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
}
#pause-resume-button.paused {
    background: linear-gradient(135deg, #00f3ff 0%, #a855f7 100%);
    color: #0a0e27;
}
#pause-resume-button.paused:hover {
    background: linear-gradient(135deg, #a855f7 0%, #00f3ff 100%);
}

/* Bookmark Button */
#bookmark-button {
    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    margin: 5px 3px;
    color: #0a0e27;
}
#bookmark-button:hover {
    background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
}
#bookmark-button.bookmarked {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    box-shadow: 0 0 25px rgba(251, 191, 36, 0.6);
}

/* Export Button */
#export-results-button {
    background-color: #9b59b6;
    margin-top: 15px;
}
#export-results-button:hover {
    background-color: #8e44ad;
}

/* Keyboard Shortcuts Help */
#shortcuts-help {
    position: fixed;
    bottom: 20px;
    left: 20px;
    background-color: rgba(52, 152, 219, 0.9);
    color: white;
    padding: 10px 15px;
    border-radius: 6px;
    font-size: 0.85em;
    display: none;
    z-index: 1000;
}
body.dark-mode #shortcuts-help {
    background-color: rgba(243, 156, 18, 0.9);
}

/* Pause Overlay */
#pause-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.8);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 2000;
}
#pause-overlay-content {
    background-color: white;
    padding: 40px;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}
body.dark-mode #pause-overlay-content {
    background-color: #2d3748;
    color: #e2e8f0;
}
#pause-overlay-content h2 {
    margin-top: 0;
    color: #f39c12;
}

/* Mobile Responsiveness */
@media (max-width: 600px) {
    body {
        padding: 5px;
    }
    #exam-container {
        padding: 15px;
        width: 100%;
        box-sizing: border-box;
    }
    h1#exam-title {
        font-size: 1.5em;
    }
    .button-base, select, input[type="text"], input[type="number"] {
        font-size: 16px;
    }
    .choice {
        padding: 10px;
    }
    .choice label {
        font-size: 0.95em;
    }
    #load-url-button, #browse-file-button, #run-demo-button {
        width: 100%;
        margin-left: 0;
        margin-bottom: 10px;
        box-sizing: border-box;
    }
    #file-input-container {
        display: flex;
        flex-direction: column;
    }
    #selected-file-name {
        margin-left: 0;
        margin-top: 5px;
        text-align: center;
    }
    #question-navigator {
        display: none !important;
    }
    #dark-mode-toggle {
        top: 10px;
        right: 10px;
        width: 35px;
        height: 35px;
    }
}

</style>
</head>
<body>

<!-- Dark Mode Toggle -->
<button id="dark-mode-toggle" title="Toggle Dark Mode" aria-label="Toggle Dark Mode">🌙</button>

<!-- Dashboard Button -->
<button id="dashboard-button" title="View Dashboard" aria-label="View Dashboard" style="position: fixed; top: 20px; left: 20px; z-index: 1000; background-color: #8b5cf6; border: none; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.2em; transition: background-color 0.3s ease, transform 0.2s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">📊</button>

<!-- Question Navigator -->
<div id="question-navigator" role="navigation" aria-label="Question navigator">
  <h4>Questions</h4>
  <div class="nav-grid" id="nav-grid" role="group" aria-label="Question list"></div>
</div>

<!-- Pause Overlay -->
<div id="pause-overlay">
  <div id="pause-overlay-content">
    <h2>⏸️ Exam Paused</h2>
    <p>Press "Resume" or Space to continue</p>
    <button id="resume-from-overlay-button" class="button-base nav-button">Resume</button>
  </div>
</div>

<!-- Keyboard Shortcuts Help -->
<div id="shortcuts-help">
  <strong>Shortcuts:</strong> ← Prev | → Next | Space Pause | B Bookmark | ? Help
</div>

<div id="exam-container">
  <h1 id="exam-title">Open Exam Application</h1>
   <p id="welcome-message"></p>

  <div id="initial-load-instructions">
    <p id="custom-instructions-text"></p>
    <div id="default-instructions-text">
      <p>Instructions:</p>
      <ul>
        <li>Select an exam bank by loading from a URL or a local file.</li>
        <li>Alternatively, run the built-in Demo Exam.</li>
        <li>Once an exam is loaded, configure the number of questions and time limit.</li>
        <li>Click 'Start Exam' to begin.</li>
      </ul>
     </div>
    <label for="json-url">Load from URL (optional):</label>
    <input type="text" id="json-url" placeholder="Enter JSON URL...">
    <button id="load-url-button" class="button-base">Load from URL</button>

    <div style="margin-top: 20px; margin-bottom: 15px;">
        <hr style="border: 0; border-top: 1px solid #e0e6ed;">
    </div>

    <div id="file-input-container">
        <label for="browse-file-button">Load from Local File:</label>
        <input type="file" id="json-file" accept=".json" style="display: none;">
        <button id="browse-file-button" class="button-base">Browse File</button>
        <span id="selected-file-name">No file selected</span>
    </div>
    <button id="run-demo-button" class="button-base">Run Demo Exam</button>
  </div>

  <div id="exam-setup-options" style="display: none;">
    <h4>Exam Setup</h4>
    <div class="setup-option-group">
        <input type="radio" id="setup-default" name="exam-setup-type" value="default" checked>
        <label for="setup-default" class="inline-label">Use default settings from exam file</label>
        <div id="default-settings-info" class="setup-details"></div>
    </div>
    <div class="setup-option-group">
        <input type="radio" id="setup-quick" name="exam-setup-type" value="quick">
        <label for="setup-quick" class="inline-label">Quick Start (Random questions from all topics)</label>
    </div>
    <div class="setup-option-group">
        <input type="radio" id="setup-custom-domain" name="exam-setup-type" value="custom_domain">
        <label for="setup-custom-domain" class="inline-label">Custom Selection (Choose specific topics)</label>
        <div id="custom-domain-options-container" class="setup-details" style="display: none;">
            <p>Select one or more topics:</p>
            <div id="custom-domain-selection"></div>
        </div>
    </div>
    
    <div class="setup-option-group">
        <input type="checkbox" id="show-time-warning-checkbox">
        <label for="show-time-warning-checkbox" class="inline-label">Show time warning on questions</label>
    </div>

    <div id="custom-exam-common-options" style="display: none;">
        <hr style="border: 0; border-top: 1px solid #e0e6ed;">
        <div>
            <label for="custom-question-count-select">Number of Questions:</label>
            <select id="custom-question-count-select">
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="20">20</option>
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="custom">Custom...</option>
            </select>
            <input type="number" id="custom-question-count-input" min="1" class="short-input" style="display: none;" placeholder="Qty">
        </div>
        <div>
            <label for="exam-duration-setup-input">Time Limit (minutes, 0 for unlimited):</label>
            <input type="number" id="exam-duration-setup-input" min="0" value="60">
        </div>
        <p id="custom-setup-warning"></p>
    </div>

    <p id="effective-settings-summary"></p>
    <button id="start-button" class="button-base">Start Exam</button>
  </div>


  <div id="progress-bar-container" style="display: none;">
        <div id="progress-bar"></div>
  </div>
  <p id="progress-text" style="display: none;"></p>
  <div id="timer" style="display: none;">Time Remaining: <span id="time-remaining"></span></div>

  <div id="question-container" style="display: none;" role="main" aria-live="polite">
    <div id="question" role="heading" aria-level="2"></div>
    <button id="back-button" class="nav-button button-base" disabled aria-label="Go to previous question">Back</button>
    <button id="next-button" class="nav-button button-base" aria-label="Go to next question">Next</button>
    <button id="submit-button" class="nav-button button-base" style="display: none;" aria-label="Submit exam">Submit</button>
    <button id="pause-resume-button" class="button-base" style="display: none;" aria-label="Pause exam">⏸️ Pause</button>
    <button id="bookmark-button" class="button-base" aria-label="Bookmark this question">🔖 Bookmark</button>
  </div>

  <div id="results-container" style="display: none;">
    <h2>Results</h2>
    <p>Correct Answers: <span id="correct-answers"></span></p>
    <p>Incorrect Answers: <span id="incorrect-answers"></span></p>
    <p>Unanswered: <span id="unanswered-questions"></span></p>
    <p>Percentage: <span id="percentage"></span>%</p>
    <p>Confidence Score: <span id="confidence-score"></span></p>
    <p>Average Time per Question: <span id="average-time"></span></p>
    <h3>Results by Domain (Best to Worst)</h3>
    <div id="domain-results"></div>
    <p>Review Questions:</p>
    <p>Correct: <span id="correct-review" class="review-link"></span></p>
    <p>Incorrect: <span id="incorrect-review" class="review-link"></span></p>
    <p>Unanswered: <span id="unanswered-review" class="review-link"></span></p>
    <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button id="export-results-button" class="button-base">📥 Export Results</button>
        <button id="view-dashboard-button" class="button-base" style="background: linear-gradient(135deg, #a855f7 0%, #d946ef 100%);">📊 View Dashboard</button>
    </div>
    <div id="redirect-notification" style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, rgba(0, 243, 255, 0.15) 0%, rgba(168, 85, 247, 0.15) 100%); border: 2px solid rgba(0, 243, 255, 0.5); border-radius: 8px; text-align: center; box-shadow: 0 0 20px rgba(0, 243, 255, 0.3);">
        <p style="margin: 0; color: #00f3ff; font-weight: 600; text-shadow: 0 0 8px rgba(0, 243, 255, 0.8);">🚀 Redirecting to dashboard in <span id="redirect-countdown">3</span> seconds...</p>
    </div>
  </div>

  <div id="review-container" style="display: none;">
    <h3>Review Questions</h3>
    <div id="review-list"></div>
    <button id="review-return-button" class="nav-button button-base">Return to Results</button>
  </div>

  <div id="user-agreement" style="padding: 20px; background-color: #f0f4f8; border: 1px solid #d1d8e0; border-radius: 8px; margin-top: 30px;">
    <details>
        <summary style="font-weight: bold; cursor: pointer; color: #2c3e50; font-size: 1.2em;">Terms of Use</summary>
        <div style="margin-top: 15px;">
            <p>This software is provided free of charge and is intended for educational and informational purposes. By using this application, you agree to the following terms and conditions:</p>
            
            <h4 style="color: #34495e; margin-top: 20px; margin-bottom: 10px;">1. AI-Generated Software</h4>
            <p>Please be aware that this software is 100% generated by an Artificial Intelligence (AI) system. As such, it may contain unexpected behaviors, inaccuracies, or errors.</p>
            
            <h4 style="color: #34495e; margin-top: 20px; margin-bottom: 10px;">2. Disclaimer of Warranty and Limitation of Liability</h4>
            <p>This software is provided "as is," without any warranty of any kind. The developer makes no guarantees regarding the performance, correctness, or reliability of the software and assumes no responsibility for any output or results generated by it.</p>
            <ul>
                <li><strong>No Support:</strong> The developer provides no user support for this application.</li>
                <li><strong>No Obligation:</strong> The developer has no obligation to provide maintenance, support, updates, or new features.</li>
            </ul>

            <h4 style="color: #34495e; margin-top: 20px; margin-bottom: 10px;">3. License and Usage Rights</h4>
            <ul>
                <li><strong>Permitted Use:</strong> This software is free for everyone to use for any purpose, including personal, educational, and commercial use.</li>
                <li><strong>Distribution:</strong> You are free to distribute and share this software with others.</li>
                <li><strong>Modification:</strong> You are encouraged to copy, modify, adapt, and improve the software. However, any modifications must not violate any applicable laws or regulations.</li>
                <li><strong>Commercial Rights:</strong>
                    <ul>
                        <li>The original, unmodified version of this software may not be sold.</li>
                        <li>You may sell a modified version of this software if you have added significant features or functionality.</li>
                        <li>The original test banks provided with this software are not for sale under any circumstances.</li>
                    </ul>
                </li>
            </ul>

            <h4 style="color: #34495e; margin-top: 20px; margin-bottom: 10px;">4. Attribution</h4>
            <p>If you modify this application, you must give appropriate credit to the original author, Worakorn Kuruwongwattana. Furthermore, if you use this application or any modified version of it for commercial or business purposes, you must include a visible and appropriate credit to Worakorn Kuruwongwattana.</p>

            <h4 style="color: #34495e; margin-top: 20px; margin-bottom: 10px;">5. Privacy</h4>
            <p>For users with privacy concerns, we recommend downloading the application from its official GitHub repository and running it locally on your own machine. This ensures that no data is transmitted to any external servers. You can access the repository at: <a href="https://github.com/worakorn/Open-Exam-Application" target="_blank">https://github.com/worakorn/Open-Exam-Application</a></p>
            
            <h4 style="color: #34495e; margin-top: 20px; margin-bottom: 10px;">6. Contact</h4>
            <p>For any questions or inquiries, you can reach out via LinkedIn: <a href="https://www.linkedin.com/in/kworakorn/" target="_blank">https://www.linkedin.com/in/kworakorn/</a></p>
        </div>
    </details>
  </div>
</div>

<div id="version-info"></div>

<script>
const APP_VERSION = "2.0.0";
const DEBUG = true; // Set to false to hide console logs

const defaultExamData = {
  "Exam Name": "Demo Exam",
  "Number of Questions": 3,
  "Default Time": 1,
  "BackNavigation": true,
  "Questions": [
    { "DomainOfKnowledge": "JavaScript Basics", "Question": "What is the output of console.log(2 + 2);", "Choices": ["22", "4", "0", "Error"], "AnswerKey": "4", "Explaination": "2 + 2 equals 4." },
    { "DomainOfKnowledge": "JavaScript Basics", "Question": "Which keyword declares a variable?", "Choices": ["define", "variable", "var"], "AnswerKey": "var", "Explaination": "'var', 'let', or 'const'." },
    { "DomainOfKnowledge": "DOM Manipulation", "Question": "Method to select by ID?", "Choices": ["getElementByClass", "querySelector", "getElementById"], "AnswerKey": "getElementById", "Explaination": "getElementById() selects by ID." }
  ]
};

let examData = null;

// DOM Elements
const initialLoadInstructionsDiv = document.getElementById('initial-load-instructions');
const examSetupOptionsDiv = document.getElementById('exam-setup-options');
const setupDefaultRadio = document.getElementById('setup-default');
const setupQuickRadio = document.getElementById('setup-quick');
const setupCustomDomainRadio = document.getElementById('setup-custom-domain');
const defaultSettingsInfoDiv = document.getElementById('default-settings-info');
const customDomainOptionsContainerDiv = document.getElementById('custom-domain-options-container');
const customDomainSelectionDiv = document.getElementById('custom-domain-selection');
const customExamCommonOptionsDiv = document.getElementById('custom-exam-common-options');
const customQuestionCountSelect = document.getElementById('custom-question-count-select');
const customQuestionCountInput = document.getElementById('custom-question-count-input');
const customSetupWarningP = document.getElementById('custom-setup-warning');
const examDurationSetupInput = document.getElementById('exam-duration-setup-input');
const effectiveSettingsSummaryP = document.getElementById('effective-settings-summary');
const showTimeWarningCheckbox = document.getElementById('show-time-warning-checkbox');

const questionContainer = document.getElementById('question-container');
const choicesContainer = document.getElementById('question-container');
const questionElement = document.getElementById('question');
const backButton = document.getElementById('back-button');
const nextButton = document.getElementById('next-button');
const submitButton = document.getElementById('submit-button');
const timerDiv = document.getElementById('timer');
const timeRemainingSpan = document.getElementById('time-remaining');
const resultsContainer = document.getElementById('results-container');
const correctAnswersSpan = document.getElementById('correct-answers');
const incorrectAnswersSpan = document.getElementById('incorrect-answers');
const unansweredQuestionsSpan = document.getElementById('unanswered-questions');
const percentageSpan = document.getElementById('percentage');
const startButton = document.getElementById('start-button');
const runDemoButton = document.getElementById('run-demo-button');
const browseFileButton = document.getElementById('browse-file-button');
const selectedFileNameSpan = document.getElementById('selected-file-name');
const correctReviewSpan = document.getElementById('correct-review');
const incorrectReviewSpan = document.getElementById('incorrect-review');
const unansweredReviewSpan = document.getElementById('unanswered-review');
const reviewContainer = document.getElementById('review-container');
const reviewListDiv = document.getElementById('review-list');
const reviewReturnButton = document.getElementById('review-return-button');
const domainResultsDiv = document.getElementById('domain-results');
const loadUrlButton = document.getElementById('load-url-button');
const jsonUrlInput = document.getElementById('json-url');
const jsonFileInput = document.getElementById('json-file');
const examTitle = document.getElementById('exam-title');
const customInstructionsTextP = document.getElementById('custom-instructions-text');
const defaultInstructionsTextDiv = document.getElementById('default-instructions-text');
const welcomeMessage = document.getElementById('welcome-message');
const progressBarContainer = document.getElementById('progress-bar-container');
const progressBar = document.getElementById('progress-bar');
const progressText = document.getElementById('progress-text');
const averageTimeSpan = document.getElementById('average-time');
const versionInfoDiv = document.getElementById('version-info');
const darkModeToggle = document.getElementById('dark-mode-toggle');
const questionNavigator = document.getElementById('question-navigator');
const navGrid = document.getElementById('nav-grid');
const pauseResumeButton = document.getElementById('pause-resume-button');
const bookmarkButton = document.getElementById('bookmark-button');
const exportResultsButton = document.getElementById('export-results-button');
const pauseOverlay = document.getElementById('pause-overlay');
const resumeFromOverlayButton = document.getElementById('resume-from-overlay-button');
const shortcutsHelp = document.getElementById('shortcuts-help');
const dashboardButton = document.getElementById('dashboard-button');
const viewDashboardButton = document.getElementById('view-dashboard-button');

// State Variables
let currentQuestionIndex = 0;
let userAnswers = {};
let correctAnswersCount = 0;
let incorrectAnswersCount = 0;
let timerInterval;
let timeRemaining;
let examStartTime;
let correctQuestionsList = [];
let incorrectQuestionsList = [];
let unansweredQuestionsList = [];
let randomizedExamData = [];
let maxQuestionsInBank = 0;
let isBackNavigationDisabled = false;
let questionStartTime = 0;
let confidenceScores = [];
let avgTimePerQuestionForConfidence = 0;
let showTimeWarning = false;
let questionTimeSpent = [];
let isPaused = false;
let bookmarkedQuestions = new Set();

const TIME_PER_QUESTION_SECONDS = 90;
const STORAGE_KEY = 'examAppState';

let currentExamSetup = {
    type: 'default',
    numQuestions: 0,
    totalTimeMinutes: 0,
    selectedDomains: []
};

// --- Event Listeners Setup ---
function setupEventListeners() {
    startButton.addEventListener('click', startActualExam);
    backButton.addEventListener('click', goBack);
    nextButton.addEventListener('click', goNext);
    submitButton.addEventListener('click', submitActualExam);
    reviewReturnButton.addEventListener('click', returnToResults);
    loadUrlButton.addEventListener('click', loadExamDataFromUrl);
    if (browseFileButton) browseFileButton.addEventListener('click', () => jsonFileInput.click());
    jsonFileInput.addEventListener('change', handleFileSelectAndLoad);
    runDemoButton.addEventListener('click', startDemoExam);
    darkModeToggle.addEventListener('click', toggleDarkMode);
    pauseResumeButton.addEventListener('click', togglePause);
    resumeFromOverlayButton.addEventListener('click', togglePause);
    bookmarkButton.addEventListener('click', toggleBookmark);
    exportResultsButton.addEventListener('click', exportResults);
    dashboardButton.addEventListener('click', () => {
        window.location.href = 'dashboard.html';
    });
    if (viewDashboardButton) {
        viewDashboardButton.addEventListener('click', () => {
            window.location.href = 'dashboard.html?from=exam';
        });
    }

    document.addEventListener('keydown', handleKeyboardShortcuts);

    document.querySelectorAll('input[name="exam-setup-type"]').forEach(radio => {
        radio.addEventListener('change', handleSetupTypeChange);
    });
    customQuestionCountSelect.addEventListener('change', handleQuestionCountSelectChange);
    customQuestionCountInput.addEventListener('input', updateCurrentExamSetup);
    examDurationSetupInput.addEventListener('input', updateCurrentExamSetup);
    showTimeWarningCheckbox.addEventListener('change', (e) => { showTimeWarning = e.target.checked; });
}
window.addEventListener('DOMContentLoaded', () => {
    if (versionInfoDiv) {
        versionInfoDiv.innerText = `Exam System v${APP_VERSION}`;
    }
    setupEventListeners();
    loadDarkModePreference();
    checkForSavedExam();

    // Show shortcuts help briefly on first load
    setTimeout(() => {
        shortcutsHelp.style.display = 'block';
        setTimeout(() => { shortcutsHelp.style.display = 'none'; }, 5000);
    }, 1000);
});


// --- Core Logic Functions ---

function handleFileSelectAndLoad(event) {
    const file = event.target.files[0];
    if (file) { selectedFileNameSpan.textContent = file.name; loadExamDataFromFile(file); }
    else { selectedFileNameSpan.textContent = "No file selected"; }
}

function handleQuestionCountSelectChange() {
    if (customQuestionCountSelect.value === 'custom') {
        customQuestionCountInput.style.display = 'inline-block';
        customQuestionCountInput.focus();
    } else {
        customQuestionCountInput.style.display = 'none';
    }
    updateCurrentExamSetup();
}

function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

function validateExamData(data) {
    if (!data) { alert("Error: Exam data is null or undefined."); return false; }
    if (!data["Exam Name"]) { alert("Error: 'Exam Name' is missing."); return false; }
    if (typeof data["Number of Questions"] !== 'number' || data["Number of Questions"] <= 0) { alert("Error: 'Number of Questions' must be a positive number."); return false; }
    if (typeof data["Default Time"] !== 'number' || data["Default Time"] < 0) { alert("Error: 'Default Time' must be a non-negative number."); return false; }
    if (data.BackNavigation !== undefined && typeof data.BackNavigation !== 'boolean') { alert("Error: 'BackNavigation' must be a boolean (true or false) if present."); return false; }
    if (!Array.isArray(data.Questions)) { /* Allow empty */ } 
    else {
        for (const question of data.Questions) {
           if (!question.DomainOfKnowledge || !question.Question || !question.Choices || !question.AnswerKey || !question.Explaination) { alert("Error: A question is missing required fields."); return false; }
           if (!Array.isArray(question.Choices) || question.Choices.length < 2) { alert("Error: Each question must have at least two choices."); return false; }
           if (!question.Choices.includes(question.AnswerKey)) { alert(`Error: AnswerKey '${question.AnswerKey}' for Q "${question.Question}" not in Choices.`); return false; }
        }
    }
    if (data.DomainPercentages) {
        if (typeof data.DomainPercentages !== 'object'){ alert("Error: DomainPercentages must be an object"); return false; }
        let totalPercentage = 0;
        for (const domain in data.DomainPercentages) {
            const percentage = data.DomainPercentages[domain];
            if (typeof percentage !== 'number' || percentage < 0 || percentage > 100) { alert(`Error: Invalid percentage for domain '${domain}'.`); return false; }
            totalPercentage += percentage;
        }
        if (totalPercentage > 100) { alert("Error: Total domain percentages exceed 100%."); return false; }
    }
    return true;
}

function prepareQuestionsByPercentage(totalItems, domainPercentages, allQuestions) {
    if(DEBUG) console.log("--- Starting New Percentage Distribution Algorithm ---");

    const questionsByDomain = {};
    allQuestions.forEach(q => {
        (questionsByDomain[q.DomainOfKnowledge] = questionsByDomain[q.DomainOfKnowledge] || []).push(q);
    });
    for (const domain in questionsByDomain) {
        shuffleArray(questionsByDomain[domain]);
    }

    if(DEBUG) {
        console.log("Available questions per domain in bank:");
        for(const domain in questionsByDomain) {
            console.log(`- ${domain}: ${questionsByDomain[domain].length} questions`);
        }
    }

    let selectedQuestions = [];
    let questionBuckets = {};
    let totalSelectedCount = 0;

    // 1. & 2. Calculate base bucket size and fill initial questions
    if(DEBUG) console.log("Step 1 & 2: Calculate and fill base questions");
    for (const domain in domainPercentages) {
        if (questionsByDomain[domain]) {
            const percentage = domainPercentages[domain];
            const bucketSize = Math.floor(totalItems * (percentage / 100));
            const questionsToTake = Math.min(bucketSize, questionsByDomain[domain].length);
            
            questionBuckets[domain] = questionsByDomain[domain].slice(0, questionsToTake);
            totalSelectedCount += questionsToTake;

            if(DEBUG) console.log(`Domain '${domain}': ${percentage}% -> bucketSize: ${bucketSize}, taking ${questionsToTake} questions.`);
        } else {
            if(DEBUG) console.log(`Domain '${domain}' from percentages not found in question bank.`);
        }
    }

    // 3. Spread the remainder
    let remainingQuestions = totalItems - totalSelectedCount;
    if(DEBUG) console.log(`Step 3: Base selection done. ${totalSelectedCount} questions selected. ${remainingQuestions} remaining to be spread.`);

    if (remainingQuestions > 0) {
        let availableDomains = Object.keys(questionsByDomain).filter(domain => {
            const totalInDomain = questionsByDomain[domain].length;
            const selectedInDomain = questionBuckets[domain] ? questionBuckets[domain].length : 0;
            return totalInDomain > selectedInDomain;
        });

        if(DEBUG) console.log("Spreading to available domains:", availableDomains);

        let spreadIndex = 0;
        while (remainingQuestions > 0 && availableDomains.length > 0) {
            shuffleArray(availableDomains); // Randomize the order of domains to spread into
            const domainToAddTo = availableDomains[spreadIndex % availableDomains.length];
            
            const sourceQuestions = questionsByDomain[domainToAddTo];
            const bucket = questionBuckets[domainToAddTo] || [];
            
            if (bucket.length < sourceQuestions.length) {
                const nextQuestionIndex = bucket.length;
                bucket.push(sourceQuestions[nextQuestionIndex]);
                remainingQuestions--;
                totalSelectedCount++;
                if(DEBUG) console.log(`Added one more question to '${domainToAddTo}'. Remaining to spread: ${remainingQuestions}`);
            }

            // 4. If a domain is now full, remove it from the list of available domains for spreading
            if (bucket.length >= sourceQuestions.length) {
                availableDomains = availableDomains.filter(d => d !== domainToAddTo);
                if(DEBUG) console.log(`Domain '${domainToAddTo}' is now full and removed from spread pool.`);
            }
            
            spreadIndex++;
            // Safety break for infinite loops
            if (spreadIndex > totalItems * 2) {
                if(DEBUG) console.error("Breaking spread loop to prevent infinite execution.");
                break;
            }
        }
    }
    
    if(DEBUG) console.log(`Total questions selected after spread: ${totalSelectedCount}`);

    // Combine all buckets into the final list
    for (const domain in questionBuckets) {
        selectedQuestions.push(...questionBuckets[domain]);
    }

    shuffleArray(selectedQuestions); // Shuffle the final combined list
    return selectedQuestions;
}

function loadExamDataFromUrl() {
    const url = jsonUrlInput.value.trim();
    if (!url) { alert("Please enter a URL."); return; }
    fetch(url)
        .then(response => { if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`); return response.json(); })
        .then(data => { if (validateExamData(data)) { examData = data; onExamDataLoaded(); }})
        .catch(error => { console.error('Error fetching JSON:', error); alert(`Failed to load exam data. Error: ${error.message}`); });
}

function loadExamDataFromFile(selectedFile) {
  const file = selectedFile || jsonFileInput.files[0];
  if (!file) { selectedFileNameSpan.textContent = "No file selected"; return; }
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = JSON.parse(e.target.result);
      if (validateExamData(data)) { examData = data; onExamDataLoaded(); }
      else { jsonFileInput.value = ''; selectedFileNameSpan.textContent = "Invalid file. No file selected.";}
    } catch (error) {
      console.error("Error parsing JSON:", error);
      alert("Failed to parse JSON. Error: " + error.message);
      jsonFileInput.value = ''; selectedFileNameSpan.textContent = "Error. No file selected.";
    }
  };
  reader.onerror = () => { alert('Error reading file.'); jsonFileInput.value = ''; selectedFileNameSpan.textContent = "Error reading file.";};
  reader.readAsText(file);
}

function startDemoExam() {
    examData = JSON.parse(JSON.stringify(defaultExamData));
    onExamDataLoaded();
}

function onExamDataLoaded() {
    initialLoadInstructionsDiv.style.display = 'none';
    examSetupOptionsDiv.style.display = 'block';

    welcomeMessage.innerText = `Welcome to the ${examData["Exam Name"]}!`;
    examTitle.innerText = examData["Exam Name"];
    isBackNavigationDisabled = (examData.BackNavigation === false);
    maxQuestionsInBank = examData.Questions ? examData.Questions.length : 0;
    
    populateDomainCheckboxes();

    setupDefaultRadio.checked = true;
    handleSetupTypeChange();
}

function populateDomainCheckboxes() {
    if (!examData || !examData.Questions) return;
    const domains = [...new Set(examData.Questions.map(q => q.DomainOfKnowledge))];
    domains.sort();

    customDomainSelectionDiv.innerHTML = '';
    if (domains.length === 0) {
        customDomainSelectionDiv.innerHTML = '<p>No topics found in this exam bank.</p>';
        return;
    }

    domains.forEach(domain => {
        const item = document.createElement('div'); item.className = 'domain-checkbox-item';
        const checkbox = document.createElement('input'); checkbox.type = 'checkbox';
        checkbox.id = `domain-${domain.replace(/\s+/g, '-')}`; checkbox.value = domain; checkbox.name = "selectedDomain";
        const label = document.createElement('label'); label.htmlFor = checkbox.id; label.textContent = domain; label.className = 'inline-label';
        item.append(checkbox, label);
        customDomainSelectionDiv.appendChild(item);
    });

    customDomainSelectionDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', updateCurrentExamSetup);
    });
}

function handleSetupTypeChange() {
    const selectedType = document.querySelector('input[name="exam-setup-type"]:checked').value;
    currentExamSetup.type = selectedType;

    customDomainOptionsContainerDiv.style.display = (selectedType === 'custom_domain') ? 'block' : 'none';
    customExamCommonOptionsDiv.style.display = (selectedType === 'quick' || selectedType === 'custom_domain') ? 'block' : 'none';
    defaultSettingsInfoDiv.style.display = (selectedType === 'default') ? 'block' : 'none';

    updateCurrentExamSetup();
}

function getSelectedDomains() {
    return Array.from(customDomainSelectionDiv.querySelectorAll('input[name="selectedDomain"]:checked'))
                .map(cb => cb.value);
}

function updateCurrentExamSetup() {
    if (!examData) return;

    const selectedType = currentExamSetup.type;
    let numQ = 0;
    let timeM = 0;
    let backNavText = isBackNavigationDisabled ? " (Back navigation disabled)" : "";
    
    if (selectedType === 'default') {
        numQ = Math.min(examData["Number of Questions"], maxQuestionsInBank);
        timeM = examData["Default Time"];
        effectiveSettingsSummaryP.innerHTML = `Exam will start with default settings: <strong>${numQ} questions</strong>, with a time limit of <strong>${timeM > 0 ? timeM + ' minutes' : 'Unlimited'}</strong>.${backNavText}`;
        startButton.disabled = numQ <= 0;
        currentExamSetup.numQuestions = numQ;
        currentExamSetup.totalTimeMinutes = timeM;
        return;
    }

    currentExamSetup.selectedDomains = (selectedType === 'custom_domain') ? getSelectedDomains() : [];

    let questionPoolSize = (selectedType === 'custom_domain')
        ? examData.Questions.filter(q => currentExamSetup.selectedDomains.includes(q.DomainOfKnowledge)).length
        : maxQuestionsInBank;
    
    Array.from(customQuestionCountSelect.options).forEach(opt => {
        if (opt.value !== "custom") { const v = parseInt(opt.value); opt.disabled = v > questionPoolSize; opt.style.display = opt.disabled ? 'none' : ''; }
    });
    if (customQuestionCountSelect.value !== "custom" && customQuestionCountSelect.options[customQuestionCountSelect.selectedIndex].disabled) {
        customQuestionCountSelect.value = "5";
    }
    customQuestionCountInput.max = questionPoolSize;

    if (customQuestionCountSelect.value === 'custom') {
        numQ = parseInt(customQuestionCountInput.value, 10) || 0;
    } else {
        numQ = parseInt(customQuestionCountSelect.value, 10);
    }
    numQ = Math.min(numQ, questionPoolSize);
    if (numQ < 0) numQ = 0;

    timeM = parseInt(examDurationSetupInput.value, 10);
    if (isNaN(timeM) || timeM < 0) { timeM = 0; examDurationSetupInput.value = 0; }

    currentExamSetup.numQuestions = numQ;
    currentExamSetup.totalTimeMinutes = timeM;
    
    customSetupWarningP.innerText = '';
    if (selectedType === 'custom_domain' && currentExamSetup.selectedDomains.length === 0) {
        customSetupWarningP.innerText = 'Please select at least one topic to proceed.';
    }
    
    if (numQ > 0) {
        effectiveSettingsSummaryP.innerHTML = `Exam will start with: <strong>${numQ} questions</strong>. <br>Time limit: <strong>${timeM > 0 ? timeM + ' minutes' : 'Unlimited'}</strong>.${backNavText}`;
        startButton.disabled = false;
    } else {
        effectiveSettingsSummaryP.innerHTML = `Please select topics and a valid number of questions.`;
        startButton.disabled = true;
    }
}

function startActualExam() {
    updateCurrentExamSetup();
    const setup = currentExamSetup;

    if (setup.numQuestions <= 0) { alert("Please configure a valid number of questions."); return; }
    if (!examData) { alert("No exam data loaded."); return; }

    // Calculate average time for confidence score
    if (setup.totalTimeMinutes > 0 && setup.numQuestions > 0) {
        avgTimePerQuestionForConfidence = (setup.totalTimeMinutes * 60) / setup.numQuestions;
    } else if (examData["Default Time"] > 0 && examData["Number of Questions"] > 0) {
        avgTimePerQuestionForConfidence = (examData["Default Time"] * 60) / examData["Number of Questions"];
    } else {
        avgTimePerQuestionForConfidence = TIME_PER_QUESTION_SECONDS; // Fallback
    }
    if(DEBUG) console.log(`Average time for confidence score: ${avgTimePerQuestionForConfidence.toFixed(2)}s`);

    const domainPercentages = examData.DomainPercentages;
    const usePercentageLogic = ((setup.type === 'default' || setup.type === 'quick') && domainPercentages);

    if (usePercentageLogic) {
        if(DEBUG) console.log(`Using Percentage Logic for setup type: '${setup.type}'`);
        randomizedExamData = prepareQuestionsByPercentage(setup.numQuestions, domainPercentages, examData.Questions);
    } else {
        if(DEBUG) console.log(`Using Basic Logic for setup type: '${setup.type}'`);
        let questionPool = JSON.parse(JSON.stringify(examData.Questions || []));

        if (setup.type === 'custom_domain' && setup.selectedDomains.length > 0) {
            if(DEBUG) console.log('Filtering for custom domains:', setup.selectedDomains);
            questionPool = questionPool.filter(q => setup.selectedDomains.includes(q.DomainOfKnowledge));
        } else {
            if(DEBUG) console.log('Using all questions in the pool.');
        }
        
        shuffleArray(questionPool);
        if(DEBUG) console.log(`Question pool of ${questionPool.length} shuffled. Taking ${setup.numQuestions} questions.`);
        randomizedExamData = questionPool.slice(0, setup.numQuestions);
    }

    if (randomizedExamData.length === 0) { alert("Could not prepare any questions based on your selection."); return; }

    initialLoadInstructionsDiv.style.display = 'none'; examSetupOptionsDiv.style.display = 'none';
    questionContainer.style.display = 'block'; timerDiv.style.display = 'block';
    progressBarContainer.style.display = 'block'; progressText.style.display = 'block';

    currentQuestionIndex = 0; userAnswers = {}; correctAnswersCount = 0; incorrectAnswersCount = 0;
    correctQuestionsList = []; incorrectQuestionsList = []; confidenceScores = []; questionTimeSpent = []; examStartTime = Date.now();
    bookmarkedQuestions = new Set(); isPaused = false;

    const examDurationMinutes = setup.totalTimeMinutes;

    if (examDurationMinutes > 0) {
        timeRemaining = examDurationMinutes * 60;
        updateTimerDisplay();
        startTimerInterval();
        pauseResumeButton.style.display = 'inline-block';
    } else {
        timeRemainingSpan.innerText = "Unlimited";
        pauseResumeButton.style.display = 'none';
    }

    buildQuestionNavigator();
    showQuestion();
    saveExamState();
}

function updateProgress() {
    if (!randomizedExamData || randomizedExamData.length === 0) {
        progressBar.style.width = '0%';
        progressText.innerText = `Question 0 / 0`; return;
    }
    const totalQuestions = randomizedExamData.length;
    const currentQNumber = Math.min(currentQuestionIndex + 1, totalQuestions);
    const progressPercentage = totalQuestions > 0 ? (currentQNumber / totalQuestions) * 100 : 0;
    progressBar.style.width = `${progressPercentage}%`;
    progressText.innerText = `Question ${currentQNumber} / ${totalQuestions}`;
}

function showQuestion() {
  questionStartTime = Date.now(); // Record start time for confidence score
  timerDiv.classList.remove('timer-warning');
  const questionData = randomizedExamData[currentQuestionIndex];
  questionElement.innerText = `${currentQuestionIndex + 1}. ${questionData.Question}`;
  choicesContainer.querySelectorAll('.choice').forEach(el => el.remove());
    questionData.Choices.forEach((choice, index) => {
        const choiceDiv = document.createElement('div'); choiceDiv.classList.add('choice');
        const radio = document.createElement('input'); radio.type = 'radio'; radio.name = 'answer'; radio.value = choice; radio.id = `choice${index + 1}`;
        radio.addEventListener('change', () => { saveAnswer(); });
        const label = document.createElement('label'); label.htmlFor = `choice${index + 1}`; label.innerText = choice;
        choiceDiv.appendChild(radio); choiceDiv.appendChild(label);
        choicesContainer.insertBefore(choiceDiv, backButton);
    });
  if (userAnswers[currentQuestionIndex] !== undefined) {
    const answer = userAnswers[currentQuestionIndex];
    const radio = choicesContainer.querySelector(`input[name="answer"][value="${CSS.escape(answer)}"]`);
    if (radio) radio.checked = true;
  }

  if (isBackNavigationDisabled) {
      backButton.disabled = true;
      backButton.style.display = 'none';
  } else {
      backButton.disabled = currentQuestionIndex === 0;
      backButton.style.display = 'inline-block';
  }

  nextButton.style.display = currentQuestionIndex === randomizedExamData.length - 1 ? 'none' : 'inline-block';
  submitButton.style.display = currentQuestionIndex === randomizedExamData.length - 1 ? 'inline-block' : 'none';
  updateProgress();
  updateBookmarkButton();
  updateQuestionNavigator();
}

function calculateAndStoreConfidenceScore() {
    if (!randomizedExamData[currentQuestionIndex]) return;
    const timeSpent = (Date.now() - questionStartTime) / 1000;
    questionTimeSpent[currentQuestionIndex] = timeSpent;
    const isCorrect = userAnswers[currentQuestionIndex] === randomizedExamData[currentQuestionIndex].AnswerKey;
    let score = 0;

    if (timeSpent >= avgTimePerQuestionForConfidence) {
        score = isCorrect ? 0 : -50;
    } else {
        if (isCorrect) {
            score = Math.round(100 * (1 - (timeSpent / avgTimePerQuestionForConfidence)));
        } else {
            score = -50;
        }
    }
    confidenceScores[currentQuestionIndex] = score;
    if(DEBUG) console.log(`Q${currentQuestionIndex + 1}: Time spent: ${timeSpent.toFixed(2)}s, Correct: ${isCorrect}, Score: ${score}`);
}

function goNext() { saveAnswer(); calculateAndStoreConfidenceScore(); currentQuestionIndex++; showQuestion(); saveExamState(); }
function goBack() {
    if (isBackNavigationDisabled) return;
    saveAnswer(); calculateAndStoreConfidenceScore(); currentQuestionIndex--; showQuestion(); saveExamState();
}

function saveAnswer() {
  const selectedAnswerNode = choicesContainer.querySelector('input[name="answer"]:checked');
  if (selectedAnswerNode) {
      userAnswers[currentQuestionIndex] = selectedAnswerNode.value;
      updateQuestionNavigator();
      saveExamState();
  }
}

function startTimerInterval() {
  timerInterval = setInterval(() => {
    timeRemaining--; 
    updateTimerDisplay();
    if (showTimeWarning) {
        const timeSpent = (Date.now() - questionStartTime) / 1000;
        if (timeSpent > avgTimePerQuestionForConfidence) {
            timerDiv.classList.add('timer-warning');
        } else {
            timerDiv.classList.remove('timer-warning');
        }
    }
    if (timeRemaining <= 0) { clearInterval(timerInterval); alert("Time is up!"); submitActualExam(); }
  }, 1000);
}
function updateTimerDisplay() {
  const minutes = Math.floor(timeRemaining / 60); const seconds = timeRemaining % 60;
  timeRemainingSpan.innerText = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
}

function submitActualExam() {
    saveAnswer();
    calculateAndStoreConfidenceScore(); // Score the last question
    clearInterval(timerInterval);
    questionContainer.style.display = 'none'; timerDiv.style.display = 'none'; resultsContainer.style.display = 'block';
    submitButton.style.display = 'none'; nextButton.style.display = 'none'; backButton.style.display = 'none';
    progressBarContainer.style.display = 'none'; progressText.style.display = 'none';
    questionNavigator.style.display = 'none';
    pauseResumeButton.style.display = 'none';
    pauseOverlay.style.display = 'none';
    clearExamState();

    // Save exam completion time
    const examEndTime = Date.now();

    correctAnswersCount = 0; incorrectAnswersCount = 0; 
    let unansweredCount = 0;
    correctQuestionsList = []; incorrectQuestionsList = [];
    unansweredQuestionsList = [];
    const endTime = Date.now();
    const elapsedTimeInSeconds = examStartTime ? (endTime - examStartTime) / 1000 : 0;
    const numQuestionsInExam = randomizedExamData.length;
    const averageTimePerQuestion = numQuestionsInExam > 0 && elapsedTimeInSeconds > 0 ? (elapsedTimeInSeconds / numQuestionsInExam).toFixed(2) : 0;
    averageTimeSpan.innerText = `${averageTimePerQuestion} seconds`;

    const domainResults = {};
    for (let i = 0; i < numQuestionsInExam; i++) {
      const qData = randomizedExamData[i]; const userAnswer = userAnswers[i]; const domain = qData.DomainOfKnowledge;
      if (!domainResults[domain]) domainResults[domain] = { correct: 0, total: 0, percentage: 0 };
      domainResults[domain].total++;
      if (userAnswer === undefined) {
          unansweredCount++;
          unansweredQuestionsList.push(i);
      } else if (userAnswer === qData.AnswerKey) { 
          domainResults[domain].correct++; 
          correctAnswersCount++; 
          correctQuestionsList.push(i); 
      } else { 
          incorrectAnswersCount++; 
          incorrectQuestionsList.push(i); 
      } 
    }
    for (const domain in domainResults) {
        const { correct, total } = domainResults[domain];
        domainResults[domain].percentage = total > 0 ? (correct / total) * 100 : 0;
    }
    
    const percentage = numQuestionsInExam > 0 ? (correctAnswersCount / numQuestionsInExam) * 100 : 0;
    correctAnswersSpan.innerText = `${correctAnswersCount}/${numQuestionsInExam}`;
    incorrectAnswersSpan.innerText = `${incorrectAnswersCount}/${numQuestionsInExam}`;
    unansweredQuestionsSpan.innerText = `${unansweredCount}/${numQuestionsInExam}`;
    percentageSpan.innerText = percentage.toFixed(2);

    const totalConfidenceScore = confidenceScores.reduce((a, b) => a + b, 0);
    const maxConfidenceScore = numQuestionsInExam * 100;
    const confidencePercentage = maxConfidenceScore > 0 ? (totalConfidenceScore / maxConfidenceScore) * 100 : 0;
    document.getElementById('confidence-score').innerText = `${confidencePercentage.toFixed(2)}%`;
    
    const sortedDomains = Object.keys(domainResults).sort((a, b) => {
        const percentageDiff = domainResults[b].percentage - domainResults[a].percentage;
        if (percentageDiff !== 0) return percentageDiff;
        return a.localeCompare(b); // Sort alphabetically for ties
    });

    domainResultsDiv.innerHTML = '';
    sortedDomains.forEach(domain => {
      const { correct, total, percentage } = domainResults[domain];
      const el = document.createElement('div'); el.classList.add('domain-result');
      el.innerText = `${domain}: ${correct}/${total} (${percentage.toFixed(2)}%)`;
      domainResultsDiv.appendChild(el);
    });

    correctReviewSpan.style.display = correctQuestionsList.length === 0 ? 'none' : 'inline';
    if (correctQuestionsList.length > 0) { correctReviewSpan.innerText = `Review Correct (${correctQuestionsList.length})`; correctReviewSpan.onclick = () => reviewQuestionsByDomain(correctQuestionsList); }
    incorrectReviewSpan.style.display = incorrectQuestionsList.length === 0 ? 'none' : 'inline';
    if (incorrectQuestionsList.length > 0) { incorrectReviewSpan.innerText = `Review Incorrect (${incorrectQuestionsList.length})`; incorrectReviewSpan.onclick = () => reviewQuestionsByDomain(incorrectQuestionsList); }
    unansweredReviewSpan.style.display = unansweredQuestionsList.length === 0 ? 'none' : 'inline';
    if (unansweredQuestionsList.length > 0) { unansweredReviewSpan.innerText = `Review Unanswered (${unansweredQuestionsList.length})`; unansweredReviewSpan.onclick = () => reviewQuestionsByDomain(unansweredQuestionsList); }

    // Save exam result for dashboard
    const examResult = {
        id: Date.now(),
        name: examData["Exam Name"],
        date: new Date().toISOString(),
        score: percentage,
        maxScore: 100,
        timeSpent: Math.floor((examEndTime - examStartTime) / (1000 * 60)),
        status: 'completed',
        questionCount: numQuestionsInExam,
        correctAnswers: correctAnswersCount,
        incorrectAnswers: incorrectAnswersCount,
        unanswered: unansweredCount,
        confidenceScore: confidencePercentage,
        domainResults: domainResults
    };

    // Save to sessionStorage for dashboard
    sessionStorage.setItem('latestExamResult', JSON.stringify(examResult));

    // Auto-redirect to dashboard after 3 seconds with countdown
    let countdown = 3;
    const countdownSpan = document.getElementById('redirect-countdown');
    const countdownInterval = setInterval(() => {
        countdown--;
        if (countdownSpan) countdownSpan.innerText = countdown;
        if (countdown <= 0) {
            clearInterval(countdownInterval);
        }
    }, 1000);

    setTimeout(() => {
        window.location.href = 'dashboard.html?from=exam';
    }, 3000);
}

function reviewQuestionsByDomain(questionIndicesList) {
    if (questionIndicesList.length === 0) { alert("No questions to review."); return; }
    resultsContainer.style.display = 'none'; reviewContainer.style.display = 'block'; reviewListDiv.innerHTML = '';
    const domainGroups = {};
    questionIndicesList.forEach(idx => { const qD = randomizedExamData[idx]; const dom = qD.DomainOfKnowledge; if (!domainGroups[dom]) domainGroups[dom] = []; domainGroups[dom].push(idx); });
    for (const domain in domainGroups) {
        const dHeader = document.createElement('h4'); dHeader.innerText = domain;
        dHeader.style.cssText = "margin-top:20px;border-bottom:1px solid #ccc;padding-bottom:5px;";
        reviewListDiv.appendChild(dHeader);
        domainGroups[domain].forEach(qIdx => {
            const qData = randomizedExamData[qIdx]; const uAns = userAnswers[qIdx] !== undefined ? userAnswers[qIdx] : "Not Answered";
            const li = document.createElement('div'); li.classList.add('review-list-item');
            const qTextDiv = document.createElement('div'); qTextDiv.style.cssText = 'display:flex;justify-content:space-between;align-items:center;cursor:pointer;';
            const qTitle = document.createElement('div'); 
            qTitle.innerText = `Q${qIdx + 1}: ${qData.Question}`;
            
            const flagsContainer = document.createElement('span');
            flagsContainer.style.marginLeft = '10px';
            flagsContainer.style.display = 'inline-flex';
            flagsContainer.style.alignItems = 'center';

            if (uAns === "Not Answered") {
                const flag = document.createElement('span');
                flag.className = 'unanswered-flag';
                flag.style.marginRight = '5px';
                flag.innerHTML = '<svg title="Unanswered" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-circle" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>';
                flagsContainer.appendChild(flag);
            }
            
            if (uAns !== "Not Answered" && questionTimeSpent[qIdx] > avgTimePerQuestionForConfidence) {
                const flag = document.createElement('span');
                flag.className = 'time-flag';
                flag.innerHTML = '<svg title="Took a long time" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:1.2em; height:1.2em;"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>';
                flagsContainer.appendChild(flag);
            }

            if (flagsContainer.hasChildNodes()) {
                qTitle.appendChild(flagsContainer);
            }

            const arrow = document.createElement('span'); arrow.classList.add('review-arrow'); 
            arrow.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>';

            qTextDiv.append(qTitle, arrow);
            const detsDiv = document.createElement('div'); detsDiv.classList.add('review-details');
            detsDiv.innerHTML = `<p><strong>Your Answer:</strong> ${uAns}</p><p><strong>Correct Answer:</strong> ${qData.AnswerKey}</p><p><strong>Confidence Score:</strong> ${confidenceScores[qIdx]}%</p><div class="explanation"><strong>Explanation:</strong> ${qData.Explaination}</div>`;
            li.append(qTextDiv, detsDiv);
            li.addEventListener('click', (e) => { 
                if (e.target.closest('.review-details')) return; 
                window.getSelection().removeAllRanges(); 
                const isExpanded = detsDiv.style.display === 'block'; 
                detsDiv.style.display = isExpanded ? 'none' : 'block'; 
                arrow.innerHTML = isExpanded 
                    ? '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>'
                    : '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>';
            });
            reviewListDiv.appendChild(li);
        });
    }
    reviewReturnButton.innerText = "Return to Results";
}

function returnToResults() { reviewContainer.style.display = 'none'; resultsContainer.style.display = 'block'; }

// --- NEW ENHANCED FEATURES ---

// Dark Mode Functions
function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    darkModeToggle.textContent = isDark ? '☀️' : '🌙';
    localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
}

function loadDarkModePreference() {
    const darkMode = localStorage.getItem('darkMode');
    if (darkMode === 'enabled') {
        document.body.classList.add('dark-mode');
        darkModeToggle.textContent = '☀️';
    }
}

// Local Storage Functions
function saveExamState() {
    if (randomizedExamData.length === 0) return;

    const state = {
        examData: examData,
        randomizedExamData: randomizedExamData,
        currentQuestionIndex: currentQuestionIndex,
        userAnswers: userAnswers,
        timeRemaining: timeRemaining,
        examStartTime: examStartTime,
        currentExamSetup: currentExamSetup,
        bookmarkedQuestions: Array.from(bookmarkedQuestions),
        questionTimeSpent: questionTimeSpent,
        confidenceScores: confidenceScores,
        questionStartTime: questionStartTime,
        showTimeWarning: showTimeWarning,
        timestamp: Date.now()
    };

    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        if(DEBUG) console.log('Exam state saved');
    } catch (e) {
        console.error('Failed to save exam state:', e);
    }
}

function loadExamState() {
    try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (!saved) return null;

        const state = JSON.parse(saved);

        // Check if saved state is not too old (24 hours)
        const hoursSinceSave = (Date.now() - state.timestamp) / (1000 * 60 * 60);
        if (hoursSinceSave > 24) {
            localStorage.removeItem(STORAGE_KEY);
            return null;
        }

        return state;
    } catch (e) {
        console.error('Failed to load exam state:', e);
        return null;
    }
}

function clearExamState() {
    localStorage.removeItem(STORAGE_KEY);
    if(DEBUG) console.log('Exam state cleared');
}

function checkForSavedExam() {
    const state = loadExamState();
    if (!state) return;

    const resume = confirm('You have an exam in progress. Would you like to resume it?');
    if (resume) {
        restoreExamState(state);
    } else {
        clearExamState();
    }
}

function restoreExamState(state) {
    examData = state.examData;
    randomizedExamData = state.randomizedExamData;
    currentQuestionIndex = state.currentQuestionIndex;
    userAnswers = state.userAnswers;
    timeRemaining = state.timeRemaining;
    examStartTime = state.examStartTime;
    currentExamSetup = state.currentExamSetup;
    bookmarkedQuestions = new Set(state.bookmarkedQuestions || []);
    questionTimeSpent = state.questionTimeSpent || [];
    confidenceScores = state.confidenceScores || [];
    showTimeWarning = state.showTimeWarning || false;

    // Calculate avgTimePerQuestionForConfidence
    if (currentExamSetup.totalTimeMinutes > 0 && currentExamSetup.numQuestions > 0) {
        avgTimePerQuestionForConfidence = (currentExamSetup.totalTimeMinutes * 60) / currentExamSetup.numQuestions;
    } else {
        avgTimePerQuestionForConfidence = TIME_PER_QUESTION_SECONDS;
    }

    // Restore UI
    initialLoadInstructionsDiv.style.display = 'none';
    examSetupOptionsDiv.style.display = 'none';
    questionContainer.style.display = 'block';
    timerDiv.style.display = 'block';
    progressBarContainer.style.display = 'block';
    progressText.style.display = 'block';
    questionNavigator.style.display = 'block';

    welcomeMessage.innerText = `Welcome to the ${examData["Exam Name"]}!`;
    examTitle.innerText = examData["Exam Name"];
    isBackNavigationDisabled = (examData.BackNavigation === false);

    // Show pause button if timed
    if (currentExamSetup.totalTimeMinutes > 0) {
        pauseResumeButton.style.display = 'inline-block';
    }

    // Restart timer if needed
    if (timeRemaining > 0) {
        updateTimerDisplay();
        startTimerInterval();
    }

    buildQuestionNavigator();
    showQuestion();

    if(DEBUG) console.log('Exam state restored');
}

// Pause/Resume Functions
function togglePause() {
    isPaused = !isPaused;

    if (isPaused) {
        clearInterval(timerInterval);
        pauseResumeButton.textContent = '▶️ Resume';
        pauseResumeButton.classList.add('paused');
        pauseOverlay.style.display = 'flex';
        saveExamState();
    } else {
        if (timeRemaining > 0) {
            startTimerInterval();
        }
        pauseResumeButton.textContent = '⏸️ Pause';
        pauseResumeButton.classList.remove('paused');
        pauseOverlay.style.display = 'none';
        questionStartTime = Date.now(); // Reset question start time
    }
}

// Keyboard Shortcuts
function handleKeyboardShortcuts(e) {
    // Don't trigger shortcuts when typing in input fields
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
        return;
    }

    // Only active during exam
    if (questionContainer.style.display !== 'block') {
        return;
    }

    switch(e.key) {
        case 'ArrowLeft':
            if (!backButton.disabled && !isBackNavigationDisabled) {
                e.preventDefault();
                goBack();
            }
            break;
        case 'ArrowRight':
            e.preventDefault();
            if (currentQuestionIndex === randomizedExamData.length - 1) {
                if (confirm('Submit exam?')) submitActualExam();
            } else {
                goNext();
            }
            break;
        case ' ':
            e.preventDefault();
            if (pauseResumeButton.style.display !== 'none') {
                togglePause();
            }
            break;
        case 'b':
        case 'B':
            e.preventDefault();
            toggleBookmark();
            break;
        case '?':
            e.preventDefault();
            toggleShortcutsHelp();
            break;
    }
}

function toggleShortcutsHelp() {
    shortcutsHelp.style.display = shortcutsHelp.style.display === 'none' ? 'block' : 'none';
}

// Bookmark Functions
function toggleBookmark() {
    if (bookmarkedQuestions.has(currentQuestionIndex)) {
        bookmarkedQuestions.delete(currentQuestionIndex);
        bookmarkButton.textContent = '🔖 Bookmark';
        bookmarkButton.classList.remove('bookmarked');
    } else {
        bookmarkedQuestions.add(currentQuestionIndex);
        bookmarkButton.textContent = '🔖 Bookmarked';
        bookmarkButton.classList.add('bookmarked');
    }
    updateQuestionNavigator();
    saveExamState();
}

function updateBookmarkButton() {
    if (bookmarkedQuestions.has(currentQuestionIndex)) {
        bookmarkButton.textContent = '🔖 Bookmarked';
        bookmarkButton.classList.add('bookmarked');
    } else {
        bookmarkButton.textContent = '🔖 Bookmark';
        bookmarkButton.classList.remove('bookmarked');
    }
}

// Export Results Function
function exportResults() {
    const exportData = {
        examName: examData["Exam Name"],
        date: new Date().toISOString(),
        score: {
            correct: correctAnswersCount,
            incorrect: incorrectAnswersCount,
            unanswered: randomizedExamData.length - correctAnswersCount - incorrectAnswersCount,
            total: randomizedExamData.length,
            percentage: percentageSpan.textContent,
            confidenceScore: document.getElementById('confidence-score').textContent
        },
        timeStats: {
            averageTimePerQuestion: averageTimeSpan.textContent,
            totalTimeMinutes: currentExamSetup.totalTimeMinutes
        },
        domainResults: {},
        questions: []
    };

    // Add domain results
    const domainEls = domainResultsDiv.querySelectorAll('.domain-result');
    domainEls.forEach(el => {
        const text = el.textContent;
        const match = text.match(/(.+): (\d+)\/(\d+) \((.+)%\)/);
        if (match) {
            exportData.domainResults[match[1]] = {
                correct: parseInt(match[2]),
                total: parseInt(match[3]),
                percentage: match[4]
            };
        }
    });

    // Add question details
    randomizedExamData.forEach((q, idx) => {
        exportData.questions.push({
            number: idx + 1,
            domain: q.DomainOfKnowledge,
            question: q.Question,
            choices: q.Choices,
            correctAnswer: q.AnswerKey,
            userAnswer: userAnswers[idx] || 'Not Answered',
            isCorrect: userAnswers[idx] === q.AnswerKey,
            timeSpent: questionTimeSpent[idx] || 0,
            confidenceScore: confidenceScores[idx] || 0,
            bookmarked: bookmarkedQuestions.has(idx),
            explanation: q.Explaination
        });
    });

    // Create downloadable file
    const dataStr = JSON.stringify(exportData, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `exam-results-${examData["Exam Name"].replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    URL.revokeObjectURL(url);
}

// Question Navigator Functions
function buildQuestionNavigator() {
    navGrid.innerHTML = '';
    randomizedExamData.forEach((_, idx) => {
        const btn = document.createElement('div');
        btn.className = 'nav-question-btn';
        btn.textContent = idx + 1;
        btn.onclick = () => navigateToQuestion(idx);
        btn.setAttribute('role', 'button');
        btn.setAttribute('tabindex', '0');
        btn.setAttribute('aria-label', `Go to question ${idx + 1}`);
        btn.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                navigateToQuestion(idx);
            }
        });
        navGrid.appendChild(btn);
    });
    questionNavigator.style.display = 'block';
    updateQuestionNavigator();
}

function updateQuestionNavigator() {
    const buttons = navGrid.querySelectorAll('.nav-question-btn');
    buttons.forEach((btn, idx) => {
        btn.classList.remove('answered', 'current', 'bookmarked');

        if (userAnswers[idx] !== undefined) {
            btn.classList.add('answered');
        }
        if (idx === currentQuestionIndex) {
            btn.classList.add('current');
        }
        if (bookmarkedQuestions.has(idx)) {
            btn.classList.add('bookmarked');
        }
    });
}

function navigateToQuestion(index) {
    if (isPaused) return;

    saveAnswer();
    calculateAndStoreConfidenceScore();
    currentQuestionIndex = index;
    showQuestion();
}

if (typeof CSS === 'undefined' || typeof CSS.escape !== 'function') { CSS = { escape: (value) => { if (arguments.length == 0) throw new TypeError("`CSS.escape` requires an argument."); var string = String(value); var length = string.length; var index = -1; var codeUnit; var result = ''; var firstCodeUnit = string.charCodeAt(0); while (++index < length) { codeUnit = string.charCodeAt(index); if (codeUnit == 0x0000) { result += '\uFFFD'; } else if ((codeUnit >= 0x0001 && codeUnit <= 0x001F) || codeUnit == 0x007F || (index == 0 && codeUnit >= 0x0030 && codeUnit <= 0x0039) || (index == 1 && codeUnit >= 0x0030 && codeUnit <= 0x0039 && firstCodeUnit == 0x002D )) { result += '\\' + codeUnit.toString(16) + ' '; } else if ( codeUnit >= 0x0080 || codeUnit == 0x002D || codeUnit == 0x005F || (codeUnit >= 0x0030 && codeUnit <= 0x0039) || (codeUnit >= 0x0041 && codeUnit <= 0x005A) || (codeUnit >= 0x0061 && codeUnit <= 0x007A) ) { result += string.charAt(index); } else { result += '\\' + string.charAt(index); } } return result; }}; }

</script>